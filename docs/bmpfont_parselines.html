<html>

<head>
<title>bitmap font parse lines</title>
<script type="text/javascript">

// http://www.html5.jp/canvas/ref.html

var $ = function (name) {
	return document.getElementById(name);
}

/*
var req = new XMLHttpRequest();
req.open('GET', 'file:///home/user/file.json', false); 
req.send(null);
if (req.status == 0)
  dump(req.responseText);
*/

var DEFAULT_SRC = "../shnm16.png";
var img = new Image();
var ctx;
var fontSize = 0;
var nCols;
var nRows;

window.onload = function () {
	ctx = $("canvas").getContext("2d");
	ctx.mozImageSmoothingEnabled = false;
	$("defaultSrc").innerHTML = DEFAULT_SRC;
	img.src = DEFAULT_SRC;
}

img.onload = function () {
	$("imageInfo").innerHTML = ""
		+ "width : " + img.width + "<br>"
		+ "height : " + img.height + "<br>"
	;
	setFontSize();
};

function loadImage(file) {
	var fr = new FileReader();
	fr.onload = function () {
		img.src = fr.result;
	}
	fr.readAsDataURL(file);

}


function setFontSize() {
	fontSize = Number($("fontSize").value);
	nCols = img.width / fontSize;
	nRows = img.height / fontSize;
	$("fontInfo").innerHTML = ""
		+ "nCols : " + nCols + "<br>"
		+ "nRows : " + nRows
	;
	setCharCode();
}

function setCharCode() {
	var code = $("charCode").value;
	var row = Math.floor(code / nCols);
	var col = code % nCols;
	
	processChar(row, col);
}

function getBoxInfo(pixels, fontSize)
{
	var minX = fontSize;
	var minY = fontSize;
	var maxX = 0;
	var maxY = 0;
	for (var y=0; y<fontSize; ++y) {
		for (var x=0; x<fontSize; ++x) {
			if (pixels[y*fontSize+x]) {
				minX = Math.min(minX, x);
				minY = Math.min(minY, y);
				maxX = Math.max(maxX, x);
				maxY = Math.max(maxY, y);
			}
		}
	}
	return { x : minX, y : minY, w : maxX - minX + 1, h : maxY - minY + 1 };
}

function renderPixelsGrid(blockSize, ox, oy, bw, bh, pixels)
{
	var ox2 = ox + blockSize * 1;
	var oy2 = oy + blockSize * 1;0
	ctx.strokeRect(ox2-1, oy2-1, bw*blockSize+4, bh*blockSize+4);
	for (var y=0; y<bh; ++y) {
		for (var x=0; x<bw; ++x) {
			if (pixels[y*bw+x]) {
				ctx.fillStyle = "#000000";
			}else {
				ctx.fillStyle = "#FFFFFF";
			}
			ctx.fillRect(ox2+x*blockSize+2, oy2+y*blockSize+2, blockSize-2, blockSize-2);
		}
	}
	ctx.textBaseline = "top";
	ctx.font = (blockSize - 5).toString() + "px Arial";
	ctx.fillStyle = "darkblue";
	for (var i=0; i<bw; ++i) {
		var met = ctx.measureText(i).width;
		var x = ox2 + blockSize*i + (blockSize-met)/2;
		ctx.fillText(i, x, oy);
		ctx.fillText(i, x, oy2 + blockSize*(bh+0.5));
	}
	for (var i=0; i<bh; ++i) {
		var met = ctx.measureText(i).width;
		var x = ox + (blockSize-met)/2 - blockSize * 0.3;
		var y = oy2 + blockSize*i+4;
		ctx.fillText(i, x, y);
		ctx.fillText(i, x+blockSize*(bw+1.6), y);
	}
}

function compact(pixels, boxInfo)
{
	var arr = new Array(boxInfo.w * boxInfo.h);
	for (var y=0; y<boxInfo.h; ++y) {
		for (var x=0; x<boxInfo.w; ++x) {
			arr[y*boxInfo.w+x] = pixels[(boxInfo.y+y)*fontSize+boxInfo.x+x];
		}
	}
	return arr;
}

function searchHorizontalFills(pixels, boxInfo)
{
	// ‰¡•ûŒü‚Ì‚QƒhƒbƒgˆÈã‚Ì˜A‘±“h‚è‚Â‚Ô‚µ‚ð’²¸A‚Pƒhƒbƒg‚Íc•ûŒü‚Ì“h‚è‚É”C‚¹‚é
	for (var y=0; y<boxInfo.h; ++y) {
		
		
		
	}
	
	// ˜A‘±“h‚è‚Â‚Ô‚µ
		// ‘¼‚Ì“h‚è‚Â‚Ô‚µ‚ÉŽÕ‚ç‚ê‚é‚©H
		// ‘¼‚Ì“h‚è‚Â‚Ô‚µ‚ðŽÕ‚é‚©H
	
	
	
}

function searchVerticalFills(pixels, boxInfo, horizontal)
{
	
}

function searchSlantingFills(pixels, boxInfo, horizontal, vertical)
{
	
}

function searchFills(pixels, boxInfo)
{
	var fills = {};
	
	// horizontal
	fills.horizontal = searchHorizontalFills(pixels, boxInfo);
	
	// vertical
	fills.vertical = searchVerticalFills(pixels, boxInfo, fills.horizontal);
	
	// slanting
	fills.slanting = searchSlantingFills(pixels, boxInfo, fills.horizontal, fills.vertical);
	
	return fills;
}

function processChar(row, col)
{
	ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height)
	ctx.drawImage(
		img,
		col*fontSize, row*fontSize, fontSize, fontSize,
		0,0,fontSize, fontSize
		);
	var data = ctx.getImageData(0, 0, fontSize, fontSize);
	pixels = new Array(fontSize*fontSize);
	for (var y=0; y<fontSize; ++y) {
		for (var x=0; x<fontSize; ++x) {
			pixels[y*fontSize+x] = !data.data[(fontSize*y+x)*4];
		}
	}
	
	var boxInfo = getBoxInfo(pixels, fontSize);
	$("boxInfo").innerHTML = "box info<br>"
		+ "<div style='padding-left: 1.0em;'>"
		+ "x : " + boxInfo.x + "<br>"
		+ "y : " + boxInfo.y + "<br>"
		+ "w : " + boxInfo.w + "<br>"
		+ "h : " + boxInfo.h + "<br>"
		+ "</div>"
	;
	
	pixels = compact(pixels, boxInfo);
	fills = searchFills(pixels, boxInfo);
	renderPixelsGrid(20, 10, 10, boxInfo.w, boxInfo.h, pixels);
	
}

</script>
<style type="text/css">
<!--
input { ime-mode: disabled; }

-->
</style>
</head>
<body style="background-color:#aaa; line-height:150%;">

default src : <span id="defaultSrc"></span><br>
load file : <input type="file" size="80" onchange="loadImage(this.files[0]);" /><br>
<span id="imageInfo"></span>
font size : <input id="fontSize" type="number" value="16" min="0" max="32" onkeydown="if (event.which==13) setFontSize();" /><input type="button" value="set" onclick="setFontSize();" /><br>
<span id="fontInfo"></span><br>
char code : <input id="charCode" type="number" default="150" min="0" onkeydown="if (event.which==13) setCharCode();" /><input type="button" value="set" onclick="setCharCode();" /><br>
<span id="boxInfo"></span><br>
<canvas id="canvas" width="512" height="512"></canvas>


</body>
</html>
