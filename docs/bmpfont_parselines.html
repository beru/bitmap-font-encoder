<html>

<head>
<title>bitmap font parse lines</title>
<script type="text/javascript">

// http://www.html5.jp/canvas/ref.html

var $ = function (name) {
	return document.getElementById(name);
}

/*
var req = new XMLHttpRequest();
req.open('GET', 'file:///home/user/file.json', false); 
req.send(null);
if (req.status == 0)
  dump(req.responseText);
*/

var DEFAULT_SRC = "file:///C:/projects/bitmap_font_encoder/shnm16.png";
var img = new Image();
var ctx;
var fontSize = 0;
var nCols;
var nRows;
var pixels;

window.onload = function () {
	ctx = $("canvas").getContext("2d");
	ctx.mozImageSmoothingEnabled = false;
	$("defaultSrc").innerHTML = DEFAULT_SRC;
	img.src = DEFAULT_SRC;
}

img.onload = function () {
	$("imageInfo").innerHTML = ""
		+ "width : " + img.width + "<br>"
		+ "height : " + img.height + "<br>"
	;
	setFontSize();
};

function loadImage(file) {
	var fr = new FileReader();
	fr.onload = function () {
		img.src = fr.result;
	}
	fr.readAsDataURL(file);

}


function setFontSize() {
	fontSize = Number($("fontSize").value);
	nCols = img.width / fontSize;
	nRows = img.height / fontSize;
	$("fontInfo").innerHTML = ""
		+ "nCols : " + nCols + "<br>"
		+ "nRows : " + nRows
	;
	setCharCode();
}

function setCharCode() {
	var code = $("charCode").value;
	var row = Math.floor(code / nCols);
	var col = code % nCols;
	
	renderChar(row, col);
}

function renderChar(row, col)
{
	ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height)
	ctx.drawImage(
		img,
		col*fontSize, row*fontSize, fontSize, fontSize,
		0,0,fontSize, fontSize
		);
	var data = ctx.getImageData(0, 0, fontSize, fontSize);
	pixels = new Array(fontSize*fontSize);
	for (var y=0; y<fontSize; ++y) {
		for (var x=0; x<fontSize; ++x) {
			pixels[y*fontSize+x] = !data.data[(fontSize*y+x)*4];
		}
	}
	
	
	var BLOCK_SIZE = 24;
	
	var ox = BLOCK_SIZE * 2;
	var oy = BLOCK_SIZE * 2;
	
	ctx.strokeRect(ox-1, oy-1, fontSize*BLOCK_SIZE+4, fontSize*BLOCK_SIZE+4);
	for (var y=0; y<fontSize; ++y) {
		for (var x=0; x<fontSize; ++x) {
			if (pixels[y*fontSize+x]) {
				ctx.fillStyle = "#000000";
			}else {
				ctx.fillStyle = "#FFFFFF";
			}
			ctx.fillRect(ox+x*BLOCK_SIZE+2, oy+y*BLOCK_SIZE+2, BLOCK_SIZE-2, BLOCK_SIZE-2);
		}
	}
	
	ctx.textBaseline = "top";
	ctx.font = (BLOCK_SIZE - 5).toString() + "px Arial";
	ctx.fillStyle = "darkblue";
	for (var i=0; i<fontSize; ++i) {
		var met = ctx.measureText(i).width;
		var x = ox+BLOCK_SIZE*i + (BLOCK_SIZE-met)/2;
		ctx.fillText(i, x, BLOCK_SIZE);
		ctx.fillText(i, x, BLOCK_SIZE*(fontSize+2.4));
		
		var x = BLOCK_SIZE * 0.8 + (BLOCK_SIZE-met)/2;
		var y = oy+BLOCK_SIZE*i+4;
		ctx.fillText(i, x, y);
		ctx.fillText(i, x+BLOCK_SIZE*(fontSize+1.6), y);
		
//		ctx.fillRect(BLOCK_SIZE * 0.5 + (BLOCK_SIZE-met)/2, oy+BLOCK_SIZE*i, 10, 10);
	}
}

</script>
<style type="text/css">
<!--
input { ime-mode: disabled; }

-->
</style>
</head>
<body style="background-color:#aaa; line-height:150%;">

default src : <span id="defaultSrc"></span><br>
load file : <input type="file" size="80" onchange="loadImage(this.files[0]);" /><br>
<span id="imageInfo"></span>
font size : <input id="fontSize" type="number" value="16" min="0" max="32" onkeydown="if (event.which==13) setFontSize();" /><input type="button" value="set" onclick="setFontSize();" /><br>
<span id="fontInfo"></span><br>
char code : <input id="charCode" type="number" default="150" min="0" onkeydown="if (event.which==13) setCharCode();" /><input type="button" value="set" onclick="setCharCode();" /><br>
<br>
<canvas id="canvas" width="512" height="512"></canvas>


</body>
</html>
